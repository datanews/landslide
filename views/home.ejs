<!doctype html>
<html class="no-js" lang="">
  <head>
    <%- include('head.inc.ejs') %>
  </head>

  <body>
    <%- include('nav.inc.ejs') %>

    <div id="home-template-container" class="container"></div>

    <script id="home-template" type="text/ractive">
      <form class="filter-form form-inline control-group">
        <div class="form-group">
          <label for="filter-state"><%= __('filterByState') %></label>

          <select class="form-control" value="{{ filteredState }}" id="filter-state">
            <option value="" selected><%= __('all') %></option>
            {{#states:s}}
              <option value="{{ this }}">{{ this }}</option>
            {{/states}}
          </select>
        </div>

        <div class="form-group">
          <label for="filter-source"><%= __('filterBySource') %></label>

          <select class="form-control" value="{{ filteredSource }}" id="filter-source">
            <option value="" selected><%= __('all') %></option>
            {{#sources:s}}
              <option value="{{ id }}">{{ name }}</option>
            {{/sources}}
          </select>
        </div>

        <div class="data-info">
          <p>
            {{#lastFetch}}
              <small class="text-muted"><%= __('dataAsOf') %> {{ lastFetch.fromNow() }}.</small>
            {{/lastFetch}}
            <span class="loading {{#isLoading}}is-loading{{/isLoading}}"><i class="fa fa-spinner fa-pulse"></i></span>
          </p>
        </div>
      </form>

      <div class="table-responsive">
        <table class="table report-list">
          <thead>
            <tr>
              <th></th>
              <th><%= __('report') %></th>
              <th><%= __('wait') %></th>
              <th><%= __('location') %></th>
              <th><%= __('updated') %></th>
              {{^filteredSource}}
                <th><%= __('source') %></th>
              {{/filteredSource}}
              <th><%= __('inCheck') %></th>
            </tr>
          </thead>

          <tbody>
            {{#data}}
              {{#((!filteredState && !filteredSource) || (filteredState && filteredState === state) || (filteredSource && filteredSource === sourceID))}}
                <tr class="overview-row {{#details[id]}}with-details{{/details[id]}}">
                  <td class="details-toggle">
                    <span on-tap="toggleAbsolute:{{ 'details.' + id }}" class="clickable">
                      {{#details[id]}}<i class="fa fa-angle-double-down"></i>{{else}}<i class="fa fa-angle-double-right"></i>{{/details[id]}}
                    </span>
                  </td>
                  <td class="report-data"><p>{{ report }}</p></td>
                  <td class="wait-data">
                    {{#waitMinutes}}
                      {{ waitMinutes > 60 ? (waitMinutes / 60).toFixed(2) + ' hr' : waitMinutes + ' min' }}
                    {{else}}
                      <span class="text-muted">{{ wait }}</span>
                    {{/waitMinutes}}
                  </td>
                  <td>
                    {{ fullAddress }}
                  </td>
                  <td class="updated-data small text-muted">
                    {{#updatedM}}
                      <span>{{ updatedM.fromNow() }}</span>
                    {{/updatedM}}
                  </td>
                  {{^filteredSource}}
                    <td class="source-data small text-muted">{{ sourceName }}</td>
                  {{/filteredSource}}
                  <td>
                    <span class="clickable" on-tap="toggleCheck:{{ id }}">{{#inCheck}}<i class="fa fa-check-circle-o"></i>{{else}}<i class="fa fa-circle-o text-muted"></i>{{/inCheck}}</span>
                  </td>
                </tr>

                {{#details[id]}}
                  <tr class="details-row">
                    <td></td>
                    <td colspan="20">
                      <div class="details" intro-outro="slide">
                        <div class="row">
                          <div class="col-md-6">
                            <ul class="list-unstyled">
                              <li><strong>Updated</strong> {{ updatedM.format('YYYY-MM-DD hh:mm a') }}</li>
                              <li><strong>Contactable</strong> {{ contactable ? 'yes' : 'no' }}</li>
                              {{#contactable}}
                                {{#phone}}
                                  <li><strong>Phone</strong>
                                    {{ phone }}
                                    &nbsp;<a class="mobile-only-inline" href="tel:{{ phone.replace(/[^0-9]/g, '') }}" title="<%= __('callNumber') %>"><i class="fa fa-phone fa-lg"></i></a>
                                    &nbsp;<a class="mobile-only-inline" href="sms:{{ phone.replace(/[^0-9]/g, '') }}?body=<%= __('textBody') %>" title="<%= __('textNumber') %>"><i class="fa fa-mobile fa-lg"></i></a>
                                  </li>
                                {{/phone}}
                              {{/contactable}}

                              {{#(messages && messages.length)}}
                                <li><strong>All messages</strong>
                                  {{#messages}}
                                    <br>- <code title="{{ moment.unix(timestamp).format() }}">{{ body }}</code>
                                  {{/messages}}
                                </li>
                              {{/()}}
                            </ul>
                          </div>

                          <div class="col-md-6">
                            <ul class="list-unstyled">
                              <li><strong>Map link</strong>
                                {{#(fullAddress && !(lat && lon))}}
                                  <a target="_blank" rel="noopener" href="https://maps.google.com/maps?q={{ fullAddress }}"><%= __('googleMaps') %></a>
                                {{/()}}
                                {{#(lat && lon)}}
                                  <a target="_blank" rel="noopener" href="https://maps.google.com/maps?q={{ lat }},{{ lon }}"><%= __('googleMaps') %></a>
                                {{/()}}
                                {{#geocoded}}
                                  <li><strong>Accuracy</strong> {{ geocodedAccuracy }}</li>
                                  <li><strong>Formatted</strong> {{ geocodedFormatted }}</li>
                                {{/geocoded}}
                              </li>
                            </ul>
                          </div>
                        </div>

                        {{#electionProtection}}
                          <div class="election-protection">
                            <h5>Election Protection</h5>

                            <div class="row">
                              <div class="col-md-6">
                                <ul class="list-unstyled">
                                  <li><strong>Status</strong> {{ status }}</li>
                                  <li><strong>Call length</strong> {{ callLength }}</li>
                                  <li><strong>Owner</strong> {{ owner }}</li>
                                  <li><strong>Action count</strong> {{ actionCount }}</li>
                                </ul>
                              </div>

                              <div class="col-md-6">
                                <ul class="list-unstyled">
                                  <li><strong>Created</strong> {{ moment.utc(created).local().format('YYYY-MM-DD hh:mm a') }}</li>
                                  <li><strong>Issue tags</strong> {{ issueType.join(', ') }}</li>
                                  <li><strong>Link</strong> <a href="{{ url }}">Link to system</a></li>
                                </ul>
                              </div>
                            </div>
                          </div>
                        {{/electionProtection}}
                      </div>
                    </td>
                  <tr>
                {{/details[id]}}
              {{/()}}
            {{/data}}
          </tbody>
        </table>
      </div>

      <div class="exports control-group">
        <strong>Exports:</strong> &nbsp; <button class="btn btn-primary" on-tap="exportCSV"><i class="fa fa-download"></i> CSV of all reports</button>
      </div>
    </script>

    <%- include('scripts.inc.ejs') %>
  </body>
</html>
